#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1
BUILDDIR1 = src/build/mono/1.0/release
BUILDDIR2 = src/build/mono/2.0/release
export MONO_SHARED_DIR=$(CURDIR)
NANT = nant

# Include dpatch stuff.
include /usr/share/dpatch/dpatch.make

build: patch build-stamp
build-stamp:
	dh_testdir
	$(NANT) /f:src/nunit.build mono-1.0 release build
	$(NANT) /f:src/nunit.build mono-2.0 release build
	touch build-stamp

clean: unpatch
	dh_testdir
	dh_testroot
	rm -rf build
	-$(NANT) /f:src/nunit.build mono-1.0 clean-all
	-$(NANT) /f:src/nunit.build mono-2.0 clean-all
	rm -f build-stamp
	rm -rf .wapi
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k 
	dh_installdirs
	# mono-1.0
	gacutil -root debian/libnunit2.2.6-cil/usr/lib -i $(BUILDDIR1)/nunit.framework.dll 
	gacutil -root debian/libnunit2.2.6-cil/usr/lib -i $(BUILDDIR1)/nunit.core.dll
	gacutil -root debian/libnunit2.2.6-cil/usr/lib -i $(BUILDDIR1)/nunit.util.dll
	dh_install -p nunit-console $(BUILDDIR1)/nunit-console*.dll $(BUILDDIR1)/nunit-console.exe* /usr/lib/nunit/
	dh_install -p nunit-gui $(BUILDDIR1)/nunit-gui*.dll $(BUILDDIR1)/nunit-gui.exe* /usr/lib/nunit/
	dh_install -p libnunit2.2.6-cil $(BUILDDIR1)/nunit.core.dll \
		$(BUILDDIR1)/nunit.core.extensions.dll \
		$(BUILDDIR1)/nunit.framework.dll \
		$(BUILDDIR1)/nunit.mocks.dll \
		$(BUILDDIR1)/nunit.util.dll \
		/usr/lib/cli/nunit-2.2.6
	# mono-2.0
	# FIXME
	mkdir -p debian/nunit-console/usr/bin
	cp debian/nunit-console.sh debian/nunit-console/usr/bin/nunit-console
	chmod 755 debian/nunit-console/usr/bin/nunit-console

	-cd $(CURDIR)/debian && find -type f -name "*.exe" -exec chmod +x {} \;
	-cd $(CURDIR)/debian && find -type f -name "*.dll" -exec chmod -x {} \;

	# Compatibility with 2.2.7
	al -link:policy.nunit.2.2.7.config -out:policy.2.2.7.nunit.dll -keyfile:src/nunit.snk
	gacutil /i policy.2.2.7.nunit.dll

binary-indep: install
	dh_testdir -i
	dh_testroot -i
	dh_link -i
	dh_install -i
	dh_installchangelogs -i doc/ChangeLog.txt
	dh_installdocs
	dh_installexamples -i 
	dh_installmenu -i
	dh_installman -i debian/nunit-console.1
	dh_strip -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_makeclilibs -i
	dh_clideps -i -d
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary: binary-indep
.PHONY: clean build binary-indep binary install
